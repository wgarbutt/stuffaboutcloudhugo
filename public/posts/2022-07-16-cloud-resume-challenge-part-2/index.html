<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Cloud Resume Challenge – Part 2 :: Stuff About Cloud</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.
Step 8: Database For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website." />
<meta name="keywords" content="ESXi, VMWare, AWS, Amazon, Docker, Cloud, Blog" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-2/" />




<link rel="stylesheet" href="https://stuffabout.cloud/assets/style.css">






<link rel="apple-touch-icon" href="https://stuffabout.cloud/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://stuffabout.cloud/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="Will Garbutt" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Cloud Resume Challenge – Part 2">
<meta property="og:description" content="I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.
Step 8: Database For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website." />
<meta property="og:url" content="https://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-2/" />
<meta property="og:site_name" content="Stuff About Cloud" />

  
    <meta property="og:image" content="https://stuffabout.cloud/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-16 00:00:00 &#43;0000 UTC" />












</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Stuff About Cloud
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-2/">Cloud Resume Challenge – Part 2</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-16
        
      </span>
    
    
      <span class="post-author">:: Will Garbutt</span>
    
    
  </div>

  
  


  

  <div class="post-content"><div>
        <p>I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.</p>
<h2 id="step-8-database">Step 8: Database<a href="#step-8-database" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.<br>
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website. Our table will consist of two attributes, <code>record_id</code> and <code>record_count.</code><br>
I ran into an issue not quite understanding how CloudFormation wanted to have the attributes presented, in the end I created just the key attribute of <code>record_id</code> and had to manually add the <code>record_count</code> attribute from the gui.</p>
<p>I followed the Cloud Foundation documentation on DynamoDB <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html">here</a><br>
Here is my the relevant CloudFoundation YAML code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">VisitorCountTable</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Type</span>: <span style="color:#ae81ff">AWS::DynamoDB::Table</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">Properties</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">AttributeDefinitions</span>: 
</span></span><span style="display:flex;"><span>    -
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">AttributeName</span>: <span style="color:#e6db74">&#34;record_id&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">AttributeType</span>: <span style="color:#e6db74">&#34;S&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">TableName</span>: <span style="color:#e6db74">&#34;Visitor_Count&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ProvisionedThroughput</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ReadCapacityUnits</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">WriteCapacityUnits</span>: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">KeySchema</span>: 
</span></span><span style="display:flex;"><span>    - 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">AttributeName</span>: <span style="color:#e6db74">&#34;record_id&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">KeyType</span>: <span style="color:#e6db74">&#34;HASH&#34;</span>
</span></span></code></pre></div><p>Once created, log into the AWS GUI and find your DynamoDB table. Click add item, add the attribute <code>record_count</code> with an value of 1</p>
<p><img src="/Images/CloudResumeChallenge/image2.png" alt=""></p>
<h2 id="step-85-and-10-lambda-and-python">Step 8.5 and 10: Lambda and Python<a href="#step-85-and-10-lambda-and-python" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We’ll need to create two Lambda functions, one to get the visitor count and one to increase it.<br>
I again went with the CloudFormation first approach and found I was starting to get the hang of it.<br>
I followed the documentation on Lambda functions <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html">here</a></p>
<p>First I manually created a IAM role for my Lambda functions, I included the following policies</p>
<p><img src="/Images/CloudResumeChallenge/image3.png" alt=""></p>
<p>For this to work, we will need to create a couple of small Python scripts that the function will invoke</p>
<p>getvisitor.py simply connects to our DynamoDB database and returns the current value of the <code>record_count</code> attribute</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span>dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;dynamodb&#39;</span>)
</span></span><span style="display:flex;"><span>table <span style="color:#f92672">=</span> dynamodb<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;Visitor_Count&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>get_item(Key<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>       <span style="color:#e6db74">&#39;record_id&#39;</span>:<span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response<span style="color:#f92672">&amp;</span><span style="color:#75715e">#91;&#39;Item&#39;]&amp;#91;&#39;record_count&#39;]</span>
</span></span></code></pre></div><p>addvisitor.py is similar, this time increasing the current value of the <code>record_count</code> attribute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> boto3
</span></span><span style="display:flex;"><span>dynamodb <span style="color:#f92672">=</span> boto3<span style="color:#f92672">.</span>resource(<span style="color:#e6db74">&#39;dynamodb&#39;</span>)
</span></span><span style="display:flex;"><span>table <span style="color:#f92672">=</span> dynamodb<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;Visitor_Count&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">lambda_handler</span>(event, context):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>get_item(Key<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;record_id&#39;</span>:<span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    record_count <span style="color:#f92672">=</span> response<span style="color:#f92672">&amp;</span><span style="color:#75715e">#91;&#39;Item&#39;]&amp;#91;&#39;record_count&#39;]</span>
</span></span><span style="display:flex;"><span>    record_count <span style="color:#f92672">=</span> record_count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    print(record_count)
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> table<span style="color:#f92672">.</span>put_item(Item<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;record_id&#39;</span>:<span style="color:#e6db74">&#39;0&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;record_count&#39;</span>: record_count
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Records added successfully!&#34;</span>
</span></span></code></pre></div><p>We need to save and zip these two files up and upload them to a S3 bucket so the Lambda function can access</p>
<p><img src="/Images/CloudResumeChallenge/image4.png" alt=""></p>
<p>Now deploy it with the CloudFoundation YAML Code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#f92672">LambdaGetVisitor</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Type</span>: <span style="color:#e6db74">&#34;AWS::Lambda::Function&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">FunctionName</span>: <span style="color:#e6db74">&#34;CloudResumeGetVisitor&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Handler</span>: <span style="color:#e6db74">&#34;getvisitor.lambda_handler&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Architectures</span>: 
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;x86_64&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Code</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">S3Bucket</span>: <span style="color:#e6db74">&#34;cloudresumelambdafunctions&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">S3Key</span>: <span style="color:#e6db74">&#34;getvisitor.zip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Role</span>: <span style="color:#e6db74">&#34;arn:aws:iam::337461354076:role/CloudResume-LambdaFunctions&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Runtime</span>: <span style="color:#e6db74">&#34;python3.9&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">LambdaAddVisitor</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Type</span>: <span style="color:#e6db74">&#34;AWS::Lambda::Function&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">FunctionName</span>: <span style="color:#e6db74">&#34;CloudResumeAddVisitor&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Handler</span>: <span style="color:#e6db74">&#34;addvisitor.lambda_handler&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Architectures</span>: 
</span></span><span style="display:flex;"><span>              - <span style="color:#e6db74">&#34;x86_64&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Code</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">S3Bucket</span>: <span style="color:#e6db74">&#34;cloudresumelambdafunctions&#34;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">S3Key</span>: <span style="color:#e6db74">&#34;addvisitor.zip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Role</span>: <span style="color:#e6db74">&#34;arn:aws:iam::337461354076:role/CloudResume-LambdaFunctions&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Runtime</span>: <span style="color:#e6db74">&#34;python3.9&#34;</span>
</span></span></code></pre></div><p>All going well, you should have two shiny functions in your gui</p>
<p><img src="/Images/CloudResumeChallenge/image5.png" alt=""></p>
<h2 id="step-9-api">Step 9: API<a href="#step-9-api" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We’ll need to create ourselves a REST API with two methods being GET to reference our LambdaGetVisitor function and POST to reference our LambdaAddVisitor function.</p>
<p>First we create the API Gateway object, as before I have preferred to go the CloudFormation root for this deployment</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>    <span style="color:#f92672">ApiGateway</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Type</span>: <span style="color:#e6db74">&#34;AWS::ApiGateway::RestApi&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">Properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">Name</span>: <span style="color:#e6db74">&#34;visitors&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">ApiKeySourceType</span>: <span style="color:#e6db74">&#34;HEADER&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">EndpointConfiguration</span>: 
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">Types</span>: 
</span></span><span style="display:flex;"><span>                  - <span style="color:#e6db74">&#34;REGIONAL&#34;</span>
</span></span></code></pre></div><p>Pretty straightforward that one.<br>
Next we move onto the GET method, I had a pretty rough time trying to figure this part out as pure CloudFormation code. I ended up completing this in the GUI, exported the code via <a href="https://former2.com/">Former2</a>, deleting from GUI and redeploying with the newly written code.</p>
<pre tabindex="0"><code>    ApiGatewayGet:
        Type: &#34;AWS::ApiGateway::Method&#34;
        Properties:
            RestApiId: !Ref ApiGateway
            ResourceId: !GetAtt ApiGateway.RootResourceId
            HttpMethod: &#34;GET&#34;
            AuthorizationType: &#34;NONE&#34;
            ApiKeyRequired: false
            RequestParameters: {}
            MethodResponses: 
              - 
                ResponseModels: 
                    &#34;application/json&#34;: &#34;Empty&#34;
                StatusCode: &#34;200&#34;
            Integration: 
                CacheNamespace: !GetAtt ApiGateway.RootResourceId
                ContentHandling: &#34;CONVERT_TO_TEXT&#34;
                IntegrationHttpMethod: &#34;POST&#34;
                IntegrationResponses: 
                  - 
                    ResponseTemplates: {}
                    StatusCode: &#34;200&#34;
                PassthroughBehavior: &#34;WHEN_NO_MATCH&#34;
                TimeoutInMillis: 29000
                Type: &#34;AWS&#34;
                Uri: !Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaGetVisitor}/invocations&#34;
</code></pre><p>Same as above for the POST method, deployed via gui, exported code, deleted and redeployed via CloudFormation</p>
<pre tabindex="0"><code>    ApiGatewayPost:
        Type: &#34;AWS::ApiGateway::Method&#34;
        Properties:
            RestApiId: !Ref ApiGateway
            ResourceId: !GetAtt ApiGateway.RootResourceId
            HttpMethod: &#34;POST&#34;
            AuthorizationType: &#34;NONE&#34;
            ApiKeyRequired: false
            RequestParameters: {}
            MethodResponses: 
              - 
                ResponseModels: 
                    &#34;application/json&#34;: &#34;Empty&#34;
                StatusCode: &#34;200&#34;
            Integration: 
                CacheNamespace: !GetAtt ApiGateway.RootResourceId
                ContentHandling: &#34;CONVERT_TO_TEXT&#34;
                IntegrationHttpMethod: &#34;POST&#34;
                IntegrationResponses: 
                  - 
                    ResponseTemplates: {}
                    StatusCode: &#34;200&#34;
                PassthroughBehavior: &#34;WHEN_NO_MATCH&#34;
                TimeoutInMillis: 29000
                Type: &#34;AWS&#34;
                Uri: !Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaAddVisitor}/invocations&#34;
</code></pre><p>Once I deployed I went to the GUI to test my methods, but found both reported a permission denied error when I tried to run them.<br>
When deploying from the GUI you get a prompt asking if you want to give your API method access to the Lambda function, obviously that didnt happen when deploying via CloudFormation. I found <a href="https://aws.amazon.com/premiumsupport/knowledge-center/api-gateway-rest-api-lambda-integrations/">this</a> help page that exactly explained my issue.</p>
<p><img src="/Images/CloudResumeChallenge/image6.png" alt="">
Here are my code snippets to address that problem</p>
<pre tabindex="0"><code>    APIGetPermissions:
        Type: AWS::Lambda::Permission
        Properties:
          Action: &#34;lambda:InvokeFunction&#34;
          FunctionName: !Ref LambdaGetVisitor
          Principal: &#34;apigateway.amazonaws.com&#34;
          SourceArn: arn:aws:execute-api:ap-southeast-2:337461354076:&amp;lt;api-id&amp;gt;/*/GET/

    APIPostPermissions:
        Type: AWS::Lambda::Permission
        Properties:
          Action: &#34;lambda:InvokeFunction&#34;
          FunctionName: !Ref LambdaAddVisitor
          Principal: &#34;apigateway.amazonaws.com&#34;
          SourceArn: arn:aws:execute-api:ap-southeast-2:337461354076:&amp;lt;api-id&amp;gt;/*/POST/
</code></pre><p>Thats it for now, part 3 will try and merge this all together and get a nice counter on our Resume</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://stuffabout.cloud/posts/2022-08-01-docker-compose-media-stack/">
                <span class="button__icon">←</span>
                <span class="button__text">Docker Compose – Media Stack</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-3/">
                <span class="button__text">Cloud Resume Challenge – Part 3</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>2022</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://stuffabout.cloud/assets/main.js"></script>
<script src="https://stuffabout.cloud/assets/prism.js"></script>







  
</div>

</body>
</html>
