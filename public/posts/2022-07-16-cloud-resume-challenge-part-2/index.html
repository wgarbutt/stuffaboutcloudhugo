<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Cloud Resume Challenge – Part 2 ::
        Stuff About Cloud — things I&#39;ve learnt while navigating through the cloud
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.
Step 8: Database#For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="http://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-2/" />





<link rel="stylesheet" href="http://stuffabout.cloud/assets/style.css" />

<link rel="stylesheet" href="http://stuffabout.cloud/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="http://stuffabout.cloud/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="http://stuffabout.cloud/img/favicon.png" />


<link href="http://stuffabout.cloud/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="http://stuffabout.cloud/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="http://stuffabout.cloud/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="http://stuffabout.cloud/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="http://stuffabout.cloud/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="http://stuffabout.cloud/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cloud Resume Challenge – Part 2"/>
<meta name="twitter:description" content="I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.
Step 8: Database#For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website."/>



<meta property="og:title" content="Cloud Resume Challenge – Part 2" />
<meta property="og:description" content="I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.
Step 8: Database#For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-16T00:00:00+00:00" /><meta property="og:site_name" content="Stuff About Cloud" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Stuff About Cloud</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Cloud Resume Challenge – Part 2</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-07-16
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by Will Garbutt</span
        >


      
    </div>

    

    

    <div class="post-content">
      
      <p>I’ve tackled some steps of the challenge out of turn here for a bit as it made sense to me to work on the Database/Lambda/API before working on the Javascript that requires them.</p>
<h2 id="step-8-database">
  Step 8: Database
  <a href="#step-8-database" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>For this step I really leaned into trying to deploy via CloudFormation first rather than deploying via the GUI.<br>
Our Database will consist of a DynamoDB as per the recommendation on the Cloud Resume Challenge website. Our table will consist of two attributes, <code>record_id</code> and <code>record_count.</code><br>
I ran into an issue not quite understanding how CloudFormation wanted to have the attributes presented, in the end I created just the key attribute of <code>record_id</code> and had to manually add the <code>record_count</code> attribute from the gui.</p>
<p>I followed the Cloud Foundation documentation on DynamoDB <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-dynamodb-table.html">here</a><br>
Here is my the relevant CloudFoundation YAML code:</p>
<pre tabindex="0"><code>VisitorCountTable:
  Type: AWS::DynamoDB::Table
  Properties:
  AttributeDefinitions: 
    -
      AttributeName: &#34;record_id&#34;
      AttributeType: &#34;S&#34;
  TableName: &#34;Visitor_Count&#34;
  ProvisionedThroughput: 
    ReadCapacityUnits: 5
    WriteCapacityUnits: 5
  KeySchema: 
    - 
      AttributeName: &#34;record_id&#34;
      KeyType: &#34;HASH&#34;
</code></pre><p>Once created, log into the AWS GUI and find your DynamoDB table. Click add item, add the attribute <code>record_count</code> with an value of 1</p>
<p><img src="/Images/CloudResumeChallenge/image2.png" alt=""></p>
<h2 id="step-85-and-10-lambda-and-python">
  Step 8.5 and 10: Lambda and Python
  <a href="#step-85-and-10-lambda-and-python" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>We’ll need to create two Lambda functions, one to get the visitor count and one to increase it.<br>
I again went with the CloudFormation first approach and found I was starting to get the hang of it.<br>
I followed the documentation on Lambda functions <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html">here</a></p>
<p>First I manually created a IAM role for my Lambda functions, I included the following policies</p>
<p><img src="/Images/CloudResumeChallenge/image3.png" alt=""></p>
<p>For this to work, we will need to create a couple of small Python scripts that the function will invoke</p>
<p>getvisitor.py simply connects to our DynamoDB database and returns the current value of the <code>record_count</code> attribute</p>
<pre tabindex="0"><code>import json
import boto3
dynamodb = boto3.resource(&#39;dynamodb&#39;)
table = dynamodb.Table(&#39;Visitor_Count&#39;)
def lambda_handler(event, context):
    response = table.get_item(Key={
       &#39;record_id&#39;:&#39;0&#39;
    })
    return response&amp;#91;&#39;Item&#39;]&amp;#91;&#39;record_count&#39;]
</code></pre><p>addvisitor.py is similar, this time increasing the current value of the <code>record_count</code> attribute.</p>
<pre tabindex="0"><code>import json
import boto3
dynamodb = boto3.resource(&#39;dynamodb&#39;)
table = dynamodb.Table(&#39;Visitor_Count&#39;)
def lambda_handler(event, context):
    response = table.get_item(Key={
            &#39;record_id&#39;:&#39;0&#39;
    })
    record_count = response&amp;#91;&#39;Item&#39;]&amp;#91;&#39;record_count&#39;]
    record_count = record_count + 1
    print(record_count)
    response = table.put_item(Item={
            &#39;record_id&#39;:&#39;0&#39;,
            &#39;record_count&#39;: record_count
    })
    
    return &#34;Records added successfully!&#34;
</code></pre><p>We need to save and zip these two files up and upload them to a S3 bucket so the Lambda function can access</p>
<p><img src="/Images/CloudResumeChallenge/image4.png" alt=""></p>
<p>Now deploy it with the CloudFoundation YAML Code</p>
<pre tabindex="0"><code>    LambdaGetVisitor:
        Type: &#34;AWS::Lambda::Function&#34;
        Properties:
            FunctionName: &#34;CloudResumeGetVisitor&#34;
            Handler: &#34;getvisitor.lambda_handler&#34;
            Architectures: 
              - &#34;x86_64&#34;
            Code:
              S3Bucket: &#34;cloudresumelambdafunctions&#34;
              S3Key: &#34;getvisitor.zip&#34;

            Role: &#34;arn:aws:iam::337461354076:role/CloudResume-LambdaFunctions&#34;
            Runtime: &#34;python3.9&#34;

    LambdaAddVisitor:
        Type: &#34;AWS::Lambda::Function&#34;
        Properties:
            FunctionName: &#34;CloudResumeAddVisitor&#34;
            Handler: &#34;addvisitor.lambda_handler&#34;
            Architectures: 
              - &#34;x86_64&#34;
            Code:
              S3Bucket: &#34;cloudresumelambdafunctions&#34;
              S3Key: &#34;addvisitor.zip&#34;

            Role: &#34;arn:aws:iam::337461354076:role/CloudResume-LambdaFunctions&#34;
            Runtime: &#34;python3.9&#34;
</code></pre><p>All going well, you should have two shiny functions in your gui</p>
<p><img src="/Images/CloudResumeChallenge/image5.png" alt=""></p>
<h2 id="step-9-api">
  Step 9: API
  <a href="#step-9-api" class="h-anchor" aria-hidden="true">#</a>
</h2>
<p>We’ll need to create ourselves a REST API with two methods being GET to reference our LambdaGetVisitor function and POST to reference our LambdaAddVisitor function.</p>
<p>First we create the API Gateway object, as before I have preferred to go the CloudFormation root for this deployment</p>
<pre tabindex="0"><code>    ApiGateway:
        Type: &#34;AWS::ApiGateway::RestApi&#34;
        Properties:
            Name: &#34;visitors&#34;
            ApiKeySourceType: &#34;HEADER&#34;
            EndpointConfiguration: 
                Types: 
                  - &#34;REGIONAL&#34;
</code></pre><p>Pretty straightforward that one.<br>
Next we move onto the GET method, I had a pretty rough time trying to figure this part out as pure CloudFormation code. I ended up completing this in the GUI, exported the code via <a href="https://former2.com/">Former2</a>, deleting from GUI and redeploying with the newly written code.</p>
<pre tabindex="0"><code>    ApiGatewayGet:
        Type: &#34;AWS::ApiGateway::Method&#34;
        Properties:
            RestApiId: !Ref ApiGateway
            ResourceId: !GetAtt ApiGateway.RootResourceId
            HttpMethod: &#34;GET&#34;
            AuthorizationType: &#34;NONE&#34;
            ApiKeyRequired: false
            RequestParameters: {}
            MethodResponses: 
              - 
                ResponseModels: 
                    &#34;application/json&#34;: &#34;Empty&#34;
                StatusCode: &#34;200&#34;
            Integration: 
                CacheNamespace: !GetAtt ApiGateway.RootResourceId
                ContentHandling: &#34;CONVERT_TO_TEXT&#34;
                IntegrationHttpMethod: &#34;POST&#34;
                IntegrationResponses: 
                  - 
                    ResponseTemplates: {}
                    StatusCode: &#34;200&#34;
                PassthroughBehavior: &#34;WHEN_NO_MATCH&#34;
                TimeoutInMillis: 29000
                Type: &#34;AWS&#34;
                Uri: !Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaGetVisitor}/invocations&#34;
</code></pre><p>Same as above for the POST method, deployed via gui, exported code, deleted and redeployed via CloudFormation</p>
<pre tabindex="0"><code>    ApiGatewayPost:
        Type: &#34;AWS::ApiGateway::Method&#34;
        Properties:
            RestApiId: !Ref ApiGateway
            ResourceId: !GetAtt ApiGateway.RootResourceId
            HttpMethod: &#34;POST&#34;
            AuthorizationType: &#34;NONE&#34;
            ApiKeyRequired: false
            RequestParameters: {}
            MethodResponses: 
              - 
                ResponseModels: 
                    &#34;application/json&#34;: &#34;Empty&#34;
                StatusCode: &#34;200&#34;
            Integration: 
                CacheNamespace: !GetAtt ApiGateway.RootResourceId
                ContentHandling: &#34;CONVERT_TO_TEXT&#34;
                IntegrationHttpMethod: &#34;POST&#34;
                IntegrationResponses: 
                  - 
                    ResponseTemplates: {}
                    StatusCode: &#34;200&#34;
                PassthroughBehavior: &#34;WHEN_NO_MATCH&#34;
                TimeoutInMillis: 29000
                Type: &#34;AWS&#34;
                Uri: !Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaAddVisitor}/invocations&#34;
</code></pre><p>Once I deployed I went to the GUI to test my methods, but found both reported a permission denied error when I tried to run them.<br>
When deploying from the GUI you get a prompt asking if you want to give your API method access to the Lambda function, obviously that didnt happen when deploying via CloudFormation. I found <a href="https://aws.amazon.com/premiumsupport/knowledge-center/api-gateway-rest-api-lambda-integrations/">this</a> help page that exactly explained my issue.</p>
<p><img src="/Images/CloudResumeChallenge/image6.png" alt="">
Here are my code snippets to address that problem</p>
<pre tabindex="0"><code>    APIGetPermissions:
        Type: AWS::Lambda::Permission
        Properties:
          Action: &#34;lambda:InvokeFunction&#34;
          FunctionName: !Ref LambdaGetVisitor
          Principal: &#34;apigateway.amazonaws.com&#34;
          SourceArn: arn:aws:execute-api:ap-southeast-2:337461354076:&amp;lt;api-id&amp;gt;/*/GET/

    APIPostPermissions:
        Type: AWS::Lambda::Permission
        Properties:
          Action: &#34;lambda:InvokeFunction&#34;
          FunctionName: !Ref LambdaAddVisitor
          Principal: &#34;apigateway.amazonaws.com&#34;
          SourceArn: arn:aws:execute-api:ap-southeast-2:337461354076:&amp;lt;api-id&amp;gt;/*/POST/
</code></pre><p>Thats it for now, part 3 will try and merge this all together and get a nice counter on our Resume</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="http://stuffabout.cloud/posts/2022-08-01-docker-compose-media-stack/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Docker Compose – Media Stack</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="http://stuffabout.cloud/posts/2022-07-16-cloud-resume-challenge-part-3/">
                  <span class="button__text">Cloud Resume Challenge – Part 3</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Stuff About Cloud</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="http://stuffabout.cloud/assets/main.js"></script>
<script src="http://stuffabout.cloud/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
