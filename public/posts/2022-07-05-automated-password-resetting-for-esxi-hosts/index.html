<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Automated password resetting for ESXi Hosts ::
        Stuff About Cloud — things I&#39;ve learnt while navigating through the cloud
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="A few months ago I was tasked with finding a solution for resetting root passwords for 800&#43; VMWare ESXi hosts on a regular schedule.
We had recently completed a project to move our credential store to Passwordstate and had noticed it had some functionality around automating resetting and validating credentials.
I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://stuffabout.cloud/posts/2022-07-05-automated-password-resetting-for-esxi-hosts/" />





<link rel="stylesheet" href="https://stuffabout.cloud/assets/style.css" />

<link rel="stylesheet" href="https://stuffabout.cloud/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://stuffabout.cloud/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://stuffabout.cloud/img/favicon.png" />


<link href="https://stuffabout.cloud/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://stuffabout.cloud/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://stuffabout.cloud/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://stuffabout.cloud/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://stuffabout.cloud/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://stuffabout.cloud/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automated password resetting for ESXi Hosts"/>
<meta name="twitter:description" content="A few months ago I was tasked with finding a solution for resetting root passwords for 800&#43; VMWare ESXi hosts on a regular schedule.
We had recently completed a project to move our credential store to Passwordstate and had noticed it had some functionality around automating resetting and validating credentials.
I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security."/>



<meta property="og:title" content="Automated password resetting for ESXi Hosts" />
<meta property="og:description" content="A few months ago I was tasked with finding a solution for resetting root passwords for 800&#43; VMWare ESXi hosts on a regular schedule.
We had recently completed a project to move our credential store to Passwordstate and had noticed it had some functionality around automating resetting and validating credentials.
I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://stuffabout.cloud/posts/2022-07-05-automated-password-resetting-for-esxi-hosts/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-05T00:00:00+00:00" /><meta property="og:site_name" content="Stuff About Cloud" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Stuff About Cloud</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Automated password resetting for ESXi Hosts</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-07-05
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by Will Garbutt</span
        >


      
    </div>

    

    

    <div class="post-content">
      
      <p>A few months ago I was tasked with finding a solution for resetting root passwords for 800+ VMWare ESXi hosts on a regular schedule.</p>
<p>We had recently completed a project to move our credential store to <a href="https://www.clickstudios.com.au">Passwordstate</a> and had noticed it had some functionality around automating resetting and validating credentials.</p>
<p>I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security.</p>
<p>Searching through forums I found a post where someone used PowerCLI to do the heavy lifting but found the post didnt quite give me everything I needed to complete the project.</p>
<p>I made some custom scripts that do a pretty good job at completing the solution.</p>
<p>Password reset and password validation scripts:</p>
<p>We need to talk about these custom scripts first, as we need the IDs of the script to fill in the JSON data for scripted host ingest</p>
<h3 id="setting-the-esxi-password-script">
  Setting the ESXi Password Script:
  <a href="#setting-the-esxi-password-script" class="h-anchor" aria-hidden="true">#</a>
</h3>
<pre tabindex="0"><code> Function Set-ESXiPassword {
   [CmdletBinding()]
   param (
      [String]$HostName,
      [String]$UserName,
      [String]$OldPassword,
      [String]$NewPassword
   )    
   try {
      $Connection = Connect-VIServer $HostName -User $UserName -Password $OldPassword
   } 
   catch {
      switch -wildcard ($error[0].Exception.ToString().ToLower()) {
         &#34;*incorrect user*&#34; { Write-Output &#34;Incorrect username or password on host &#39;$HostName&#39;&#34; break }
         &#34;*&#34; { write-output $error[0].Exception.ToString().ToLower() break }
      }
   }
   try {
      $change = Set-VMHostAccount -UserAccount $UserName -Password $NewPassword | out-string
      if ($change -like &#39;*root*&#39;) {
         Write-Output &#34;Success&#34; 
      }
      else { 
         Write-Output &#34;Failed&#34; 
      }
      Disconnect-Viserver * -confirm:$false
   } 
   catch {
      switch -wildcard ($error[0].Exception.ToString().ToLower()) {
         &#34;*not currently connected*&#34; { Write-Output &#34;It wasn&#39;t possible to connect to &#39;$HostName&#39;&#34; break }
         &#34;*weak password*&#34; { Write-Output &#34;Failed to execute script correctly against Host &#39;$HostName&#39; for the account &#39;$UserName&#39;. It appears the new password did not meet the password complexity requirements on the host.&#34; break }
         &#34;*&#34; { write-output $error[0].Exception.ToString().ToLower() break }
         default { Write-Output &#34;Got here&#34; }
      }
   }
}
   
Set-ESXiPassword -HostName &#39;[HostName]&#39; -UserName &#39;[UserName]&#39; -OldPassword &#39;[OldPassword]&#39; -NewPassword &#39;[NewPassword]&#39;   
</code></pre><p>This script logs into a host directly via powershell and powercli modules, Passwordstate passes the common variables such as OldPassword, NewPasswork, Username etc. The Set-VMHostAccount command is actually doing all the heavy lifting here. The rest of the script is some simple error handling.</p>
<p>PowerCLI is baked into every ESXi host and only requires powershell to be open from the Passwordstate webserver to the host (port 443).</p>
<h3 id="password-validation-script">
  Password Validation Script
  <a href="#password-validation-script" class="h-anchor" aria-hidden="true">#</a>
</h3>
<pre tabindex="0"><code>Function Validate-ESXiPassword {
    [CmdletBinding()]
    param (
        [String]$HostName,
        [String]$UserName,
        [String]$CurrentPassword
    )   
    $ErrorActionPreference = &#34;Stop&#34;
       
    try {   
        $Connection = Connect-VIServer $HostName -User $UserName -Password $CurrentPassword 
        if ($Connection.isconnected) {
            Write-Output &#34;Success&#34; 
        }
        else { 
            Write-Output &#34;Failed&#34; 
        }
    }   
     
    catch {
        switch -wildcard ($error[0].Exception.ToString().ToLower()) {
            &#34;*incorrect user*&#34; {
                Write-Output &#34;Incorrect username or password on host &#39;$HostName&#39;&#34; break
                Disconnect-VIServer $HostName -Force -Confirm:$false
            }
            default { Write-Output &#34;Error is: $($error[0].Exception.message)&#34; }                   
           
        }
    }
}
Validate-ESXiPassword -HostName &#39;[HostName]&#39; -UserName &#39;[UserName]&#39; -CurrentPassword &#39;[CurrentPassword]&#39;
</code></pre><p>This script simply attempts to connect to the host in question via Powershell.</p>
<p>The success criteria simply looks for the word root in the output, this may be foolish of me, but there isn&rsquo;t much of a result from the command to parse for a successful result</p>
<p>If the command fails it should be captured by my catch commands</p>
<h3 id="hostpassword-entry">
  Host/Password Entry:
  <a href="#hostpassword-entry" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>All of our hosts are domain joined so host discovery was rather straightforward enough by using the built in utility in Passwordstate. Unfortunately there was no easy way to automatically discover host accounts, but since we are only dealing with Root here we can script adding of password entries. You&rsquo;ll need to get your custom script IDs from the ones you created above. This is a one off script and took around one minute to add 800 hosts</p>
<pre tabindex="0"><code>Connect-VIServer (your vcenter server)

$hostlist = get-vmhost 
$Creds = Get-Credential
$PasswordstateUrl = &#39;https://passwordstateurl/winapi/passwords&#39;
 
  
  foreach ($hostname in $hostlist) {
   Write-Host &#34;I am working on host $($Hostname.name)&#34;
   $jsonData = &#39;
    {
        &#34;PasswordListID&#34;:&#34;existingpasswordlistID&#34;,
        &#34;Title&#34;:&#34;&#39; + $($hostname.name) + &#39;&#34;,
        &#34;UserName&#34;:&#34;root&#34;,
        &#34;password&#34;:&#34;existingpassword&#34;,
        &#34;hostname&#34;:&#34;&#39; + $($hostname.name) + &#39;&#34;,
        &#34;AccountTypeID&#34;: &#34;34&#34;, (VMWare)
        &#34;PasswordResetEnabled&#34;: false,
        &#34;EnablePasswordResetSchedule&#34;: true,
        &#34;ScriptID&#34;: &#34;28&#34;,
        &#34;HeartbeatEnabled&#34;: true,
        &#34;ValidationScriptID&#34;: &#34;22&#34;,
    }
    &#39;
   Write-Host  $jsondata
    
   $result = Invoke-Restmethod -Method Post -Uri $PasswordstateUrl -ContentType &#34;application/json&#34; -Body $jsonData -Credential $Creds
   }
   Write-Host &#34;Disconnecting vCenter&#34;
   Disconnect-Viserver * -confirm:$false
</code></pre>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://stuffabout.cloud/posts/2022-07-14-cloud-resume-challenge-part-1/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Cloud Resume Challenge – Part 1</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Stuff About Cloud</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="https://stuffabout.cloud/assets/main.js"></script>
<script src="https://stuffabout.cloud/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
