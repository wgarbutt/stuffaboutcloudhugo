<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Automated password resetting for ESXi Hosts :: Stuff About Cloud</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A few months ago I was tasked with finding a solution for resetting root passwords for 800&#43; VMWare ESXi hosts on a regular schedule.
We had recently completed a project to move our credential store to Passwordstate and had noticed it had some functionality around automating resetting and validating credentials.
I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security." />
<meta name="keywords" content="ESXi, VMWare, AWS, Amazon, Docker, Cloud, Blog" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://stuffabout.cloud/posts/2022-07-05-automated-password-resetting-for-esxi-hosts/" />




<link rel="stylesheet" href="https://stuffabout.cloud/assets/style.css">






<link rel="apple-touch-icon" href="https://stuffabout.cloud/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://stuffabout.cloud/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="Will Garbutt" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Automated password resetting for ESXi Hosts">
<meta property="og:description" content="A few months ago I was tasked with finding a solution for resetting root passwords for 800&#43; VMWare ESXi hosts on a regular schedule.
We had recently completed a project to move our credential store to Passwordstate and had noticed it had some functionality around automating resetting and validating credentials.
I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security." />
<meta property="og:url" content="https://stuffabout.cloud/posts/2022-07-05-automated-password-resetting-for-esxi-hosts/" />
<meta property="og:site_name" content="Stuff About Cloud" />

  
    <meta property="og:image" content="https://stuffabout.cloud/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-05 00:00:00 &#43;0000 UTC" />












</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Stuff About Cloud
  </div>
</a>

    </div>
    
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://stuffabout.cloud/posts/2022-07-05-automated-password-resetting-for-esxi-hosts/">Automated password resetting for ESXi Hosts</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-05
        
      </span>
    
    
      <span class="post-author">:: Will Garbutt</span>
    
    
  </div>

  
  


  

  <div class="post-content"><div>
        <p>A few months ago I was tasked with finding a solution for resetting root passwords for 800+ VMWare ESXi hosts on a regular schedule.</p>
<p>We had recently completed a project to move our credential store to <a href="https://www.clickstudios.com.au">Passwordstate</a> and had noticed it had some functionality around automating resetting and validating credentials.</p>
<p>I initially started looking at the built-in Linux scripts which utilises SSH connections, something we have disabled for our ESXi hosts for security.</p>
<p>Searching through forums I found a post where someone used PowerCLI to do the heavy lifting but found the post didnt quite give me everything I needed to complete the project.</p>
<p>I made some custom scripts that do a pretty good job at completing the solution.</p>
<p>Password reset and password validation scripts:</p>
<p>We need to talk about these custom scripts first, as we need the IDs of the script to fill in the JSON data for scripted host ingest</p>
<h3 id="setting-the-esxi-password-script">Setting the ESXi Password Script:<a href="#setting-the-esxi-password-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> <span style="color:#66d9ef">Function</span> Set-ESXiPassword {
</span></span><span style="display:flex;"><span>   [<span style="color:#66d9ef">CmdletBinding</span>()]
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">[String]</span>$HostName,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">[String]</span>$UserName,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">[String]</span>$OldPassword,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">[String]</span>$NewPassword
</span></span><span style="display:flex;"><span>   )    
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      $Connection = Connect-VIServer $HostName -User $UserName -Password $OldPassword
</span></span><span style="display:flex;"><span>   } 
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">switch</span> <span style="color:#f92672">-wildcard</span> ($error[0].Exception.ToString().ToLower()) {
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;*incorrect user*&#34;</span> { Write-Output <span style="color:#e6db74">&#34;Incorrect username or password on host &#39;$HostName&#39;&#34;</span> <span style="color:#66d9ef">break</span> }
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;*&#34;</span> { write-output $error[0].Exception.ToString().ToLower() <span style="color:#66d9ef">break</span> }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>      $change = Set-VMHostAccount -UserAccount $UserName -Password $NewPassword | out-string
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ($change <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#39;*root*&#39;</span>) {
</span></span><span style="display:flex;"><span>         Write-Output <span style="color:#e6db74">&#34;Success&#34;</span> 
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>         Write-Output <span style="color:#e6db74">&#34;Failed&#34;</span> 
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      Disconnect-Viserver * -confirm<span style="color:#960050;background-color:#1e0010">:</span>$false
</span></span><span style="display:flex;"><span>   } 
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">switch</span> <span style="color:#f92672">-wildcard</span> ($error[0].Exception.ToString().ToLower()) {
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;*not currently connected*&#34;</span> { Write-Output <span style="color:#e6db74">&#34;It wasn&#39;t possible to connect to &#39;$HostName&#39;&#34;</span> <span style="color:#66d9ef">break</span> }
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;*weak password*&#34;</span> { Write-Output <span style="color:#e6db74">&#34;Failed to execute script correctly against Host &#39;$HostName&#39; for the account &#39;$UserName&#39;. It appears the new password did not meet the password complexity requirements on the host.&#34;</span> <span style="color:#66d9ef">break</span> }
</span></span><span style="display:flex;"><span>         <span style="color:#e6db74">&#34;*&#34;</span> { write-output $error[0].Exception.ToString().ToLower() <span style="color:#66d9ef">break</span> }
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">default</span> { Write-Output <span style="color:#e6db74">&#34;Got here&#34;</span> }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>Set-ESXiPassword -HostName <span style="color:#e6db74">&#39;[HostName]&#39;</span> -UserName <span style="color:#e6db74">&#39;[UserName]&#39;</span> -OldPassword <span style="color:#e6db74">&#39;[OldPassword]&#39;</span> -NewPassword <span style="color:#e6db74">&#39;[NewPassword]&#39;</span>   
</span></span></code></pre></div><p>This script logs into a host directly via powershell and powercli modules, Passwordstate passes the common variables such as OldPassword, NewPasswork, Username etc. The Set-VMHostAccount command is actually doing all the heavy lifting here. The rest of the script is some simple error handling.</p>
<p>PowerCLI is baked into every ESXi host and only requires powershell to be open from the Passwordstate webserver to the host (port 443).</p>
<h3 id="password-validation-script">Password Validation Script<a href="#password-validation-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">Function</span> Validate-ESXiPassword {
</span></span><span style="display:flex;"><span>    [<span style="color:#66d9ef">CmdletBinding</span>()]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">param</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">[String]</span>$HostName,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">[String]</span>$UserName,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">[String]</span>$CurrentPassword
</span></span><span style="display:flex;"><span>    )   
</span></span><span style="display:flex;"><span>    $ErrorActionPreference = <span style="color:#e6db74">&#34;Stop&#34;</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {   
</span></span><span style="display:flex;"><span>        $Connection = Connect-VIServer $HostName -User $UserName -Password $CurrentPassword 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($Connection.isconnected) {
</span></span><span style="display:flex;"><span>            Write-Output <span style="color:#e6db74">&#34;Success&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>            Write-Output <span style="color:#e6db74">&#34;Failed&#34;</span> 
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">-wildcard</span> ($error[0].Exception.ToString().ToLower()) {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;*incorrect user*&#34;</span> {
</span></span><span style="display:flex;"><span>                Write-Output <span style="color:#e6db74">&#34;Incorrect username or password on host &#39;$HostName&#39;&#34;</span> <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                Disconnect-VIServer $HostName -Force -Confirm<span style="color:#960050;background-color:#1e0010">:</span>$false
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span> { Write-Output <span style="color:#e6db74">&#34;Error is: </span>$($error[0].Exception.message)<span style="color:#e6db74">&#34;</span> }                   
</span></span><span style="display:flex;"><span>           
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Validate-ESXiPassword -HostName <span style="color:#e6db74">&#39;[HostName]&#39;</span> -UserName <span style="color:#e6db74">&#39;[UserName]&#39;</span> -CurrentPassword <span style="color:#e6db74">&#39;[CurrentPassword]&#39;</span>
</span></span></code></pre></div><p>This script simply attempts to connect to the host in question via Powershell.</p>
<p>The success criteria simply looks for the word root in the output, this may be foolish of me, but there isn&rsquo;t much of a result from the command to parse for a successful result</p>
<p>If the command fails it should be captured by my catch commands</p>
<h3 id="hostpassword-entry">Host/Password Entry:<a href="#hostpassword-entry" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>All of our hosts are domain joined so host discovery was rather straightforward enough by using the built in utility in Passwordstate. Unfortunately there was no easy way to automatically discover host accounts, but since we are only dealing with Root here we can script adding of password entries. You&rsquo;ll need to get your custom script IDs from the ones you created above. This is a one off script and took around one minute to add 800 hosts</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Connect-VIServer (your vcenter server)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$hostlist = get-vmhost 
</span></span><span style="display:flex;"><span>$Creds = Get-Credential
</span></span><span style="display:flex;"><span>$PasswordstateUrl = <span style="color:#e6db74">&#39;https://passwordstateurl/winapi/passwords&#39;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">foreach</span> ($hostname <span style="color:#66d9ef">in</span> $hostlist) {
</span></span><span style="display:flex;"><span>   Write-Host <span style="color:#e6db74">&#34;I am working on host </span>$($Hostname.name)<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>   $jsonData = <span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;PasswordListID&#34;:&#34;existingpasswordlistID&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;Title&#34;:&#34;&#39;</span> + $($hostname.name) + <span style="color:#e6db74">&#39;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;UserName&#34;:&#34;root&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;password&#34;:&#34;existingpassword&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;hostname&#34;:&#34;&#39;</span> + $($hostname.name) + <span style="color:#e6db74">&#39;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;AccountTypeID&#34;: &#34;34&#34;, (VMWare)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;PasswordResetEnabled&#34;: false,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;EnablePasswordResetSchedule&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ScriptID&#34;: &#34;28&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;HeartbeatEnabled&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;ValidationScriptID&#34;: &#34;22&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;</span>
</span></span><span style="display:flex;"><span>   Write-Host  $jsondata
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>   $result = Invoke-Restmethod -Method Post -Uri $PasswordstateUrl -ContentType <span style="color:#e6db74">&#34;application/json&#34;</span> -Body $jsonData -Credential $Creds
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   Write-Host <span style="color:#e6db74">&#34;Disconnecting vCenter&#34;</span>
</span></span><span style="display:flex;"><span>   Disconnect-Viserver * -confirm<span style="color:#960050;background-color:#1e0010">:</span>$false
</span></span></code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://stuffabout.cloud/posts/2022-07-14-cloud-resume-challenge-part-1/">
                <span class="button__icon">←</span>
                <span class="button__text">Cloud Resume Challenge – Part 1</span>
            </a>
        </span>
        
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>2022</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://stuffabout.cloud/assets/main.js"></script>
<script src="https://stuffabout.cloud/assets/prism.js"></script>







  
</div>

</body>
</html>
